title: Gitlab
tags:
  - sgd

# Gitlab

**å®˜æ–¹æ–‡æ¡£**([GitLab Docs | GitLab](https://docs.gitlab.com/ee/))

**Linux æœåŠ¡å™¨**ï¼š å®‰è£…[Gitlab](https://about.gitlab.com/)

**Window /LinuxæœåŠ¡å™¨ï¼š**å®‰è£…[Gitlab runner](https://docs.gitlab.com/runner/), powershell(ç³»ç»Ÿè‡ªå¸¦)ï¼Œ[Git](https://git-scm.com/)ï¼ˆä¸Git labäº¤äº’æ‹‰å–ï¼Œæ¨é€ä»£ç )ã€‚

## å®‰è£…Gitlab

### ä»Linux Packageå®‰è£…

[Download and install GitLab | GitLab](https://about.gitlab.com/install/)

ä»¥CentOSä¸ºä¾‹

```bash
# å¯é€‰ï¼šåœ¨ç³»ç»Ÿé˜²ç«å¢™ä¸­æ‰“å¼€ HTTPã€HTTPS å’Œ SSH è®¿é—®
sudo yum install -y curl policycoreutils-python openssh-server perl
# Enable OpenSSH server daemon if not enabled: sudo systemctl status sshd
sudo systemctl enable sshd
sudo systemctl start sshd

# Check if opening the firewall is needed with: sudo systemctl status firewalld
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo systemctl reload firewalld
```

```bash
# å¯é€‰ï¼šå®‰è£… Postfix ä»¥å‘é€é€šçŸ¥ç”µå­é‚®ä»¶
sudo yum install postfix
sudo systemctl enable postfix
sudo systemctl start postfix
```

```shell
## æ·»åŠ  GitLab åŒ…å­˜å‚¨åº“
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash

## å®‰è£…Gitlab-ceï¼ˆç¤¾åŒºç‰ˆï¼‰,ee(å•†ä¸šç‰ˆ)
sudo yum install -y gitlab-ce
```

```shell
# å¤‡ç”¨é€‰é¡¹:è®¿é—®ä¸é€šå¯æ›´æ¢é•œåƒæºï¼Œæ–°å»ºæ–‡ä»¶/etc/yum.repos.d/gitlab-ce.repo
# æˆ–è€…ç›´æ¥ä¸‹è½½rpmåŒ…ï¼Œhttps://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/
[gitlab-ce]
name=Gitlab CE Repository
baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/
gpgcheck=0
enabled=1 

# ç„¶åæ‰§è¡Œå®‰è£…
sudo yum makecache
sudo yum install -y gitlab-ce
```

### ä»Dockerå®‰è£…

```shell
# é…ç½®ä¸€ä¸ªæ–°çš„ç¯å¢ƒå˜é‡
export GITLAB_HOME=/srv/gitlab

# ä½¿ç”¨ Docker å¼•æ“å®‰è£… GitLab
sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 443:443 --publish 80:80 --publish 22:22 \
  --name gitlab \
  --restart always \
  --volume $GITLAB_HOME/config:/etc/gitlab \
  --volume $GITLAB_HOME/logs:/var/log/gitlab \
  --volume $GITLAB_HOME/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
  
# ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤ä¸­çš„ç”¨æˆ·åå’Œå¯†ç ç™»å½•ï¼šroot
sudo docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password
```



## ç®¡ç†Gitlab

```shell
 # æŸ¥çœ‹gitlabç‰ˆæœ¬
 head -1 /opt/gitlab/version-manifest.txt
 # æŸ¥çœ‹gitlabè¿è¡ŒçŠ¶æ€
 sudo gitlab-ctl status
```

ç”¨vimæ‰“å¼€gitlabçš„é…ç½®æ–‡ä»¶ï¼š`vim /etc/gitlab/gitlab.rb`

å®Œæˆé…ç½®åï¼Œæ‰§è¡Œ `gitlab-ctl reconfigure` ä½¿é…ç½®ç”Ÿæ•ˆã€‚

1. ä¿®æ”¹URLå’Œç³»ç»Ÿç«¯å£ï¼š

   `external_url 'http://127.0.0.1'`
   æ”¹ä¸ºï¼š`external_url 'http://<æœåŠ¡å™¨åœ°å€æˆ–åŸŸå>:<ç«¯å£>'`

   > è¿æ¥wifiåè·å–æœåŠ¡å™¨åœ°å€ä¸º10.55.3.117ï¼Œexternal_urlè®¾ç½®ä¸º`'http://10.55.3.117'`åï¼Œè¿åŒä¸€WiFiè®¾å¤‡ï¼ˆå³åŒä¸€å±€åŸŸç½‘ä¸‹ï¼‰å¯è®¿é—®gitlabã€‚

2. ä¿®æ”¹GitLabå¤´åƒGravataræº

```shell
vim /etc/gitlab/gitlab.rb
gitlab_rails['gravatar_plain_url'] = 'http://sdn.geekzu.org/avatar/%{hash}?s=%{size}&d=identicon'  
gitlab_rails['gravatar_ssl_url'] = 'http://sdn.geekzu.org/avatar/%{hash}?s=%{size}&d=identicon' 
```

3. æµè§ˆç®¡ç†é¡µé¢å¹¶ç™»å½•

æµè§ˆå™¨è®¿é—®æœ¬æœºåœ°å€`'http://127.0.0.1'`æˆ–è€…è‡ªå®šä¹‰çš„åŸŸå`'http://10.55.3.117'`

å¯†ç å°†åœ¨å®‰è£…è¿‡ç¨‹éšæœºç”Ÿæˆå¹¶å­˜å‚¨ 24 å°æ—¶ã€‚ç”¨æˆ·å`root` å¯†ç `/etc/gitlab/initial_root_password`

4. é‡ç½®ç”¨æˆ·å¯†ç 

```shell
sudo gitlab-rake "gitlab:password:reset"
# GitLab è¦æ±‚è¾“å…¥ç”¨æˆ·åã€å¯†ç å’Œå¯†ç ç¡®è®¤ã€‚ï¼ˆ8ä½ä»¥ä¸Šï¼Œå¯ç›´æ¥é‡ç½®ç®¡ç†å‘˜å¯†ç ,å·²ä¿®æ”¹ä¸ºrootrootï¼‰
```

â€‹	5.é€‰æ‹©è¯­è¨€
setting ----preferences----Localization---ç®€ä½“ä¸­æ–‡



## å®‰è£…Gitlab Runner

### åœ¨ Windowsä¸Šå®‰è£… GitLab Runner[ğŸ”—](https://docs.gitlab.com/runner/install/windows.html)

1. ä¸‹è½½[64 ä½](https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-windows-amd64.exe)æˆ–[32 ä½](https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-windows-386.exe)çš„äºŒè¿›åˆ¶æ–‡ä»¶æ”¾åˆ°è·¯å¾„ C:\GitLab-Runner æ–‡ä»¶å¤¹ä¸‹ï¼Œé‡å‘½åä¸ºgitlab-runner.exe

2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡ŒCMD

   ```cmd
   # å®‰è£…ä¸ºæœåŠ¡
   cd C:\GitLab-Runner
   # ä½¿ç”¨ç”¨æˆ·è´¦å·å®‰è£…
   .\gitlab-runner.exe install --user ENTER-YOUR-USERNAME --password ENTER-YOUR-PASSWORD
   # ä»¥ç®¡ç†å‘˜è´¦å·å®‰è£…
   .\gitlab-runner.exe install
   .\gitlab-runner.exe start
   ```

   ```cmd
   # æ³¨å†Œä¸€ä¸ªrunner
   ./gitlab-runner.exe register
   # ä¹‹åè¾“å…¥URL, Token, description for the runner, tags for the runner
   # URLå’Œtokenä½ç½®ï¼šé¡¹ç›®è®¾ç½®->Settings->CI/CD->Runner
   
   # ï¼ï¼tagsï¼šå½“åœ¨ymlè„šæœ¬é‡Œä½¿ç”¨ä»–çš„æ—¶å€™ï¼Œæ ¹æ®tags æŒ‡å®šè¦ä½¿ç”¨çš„runnerã€‚ä¸åŒtagå¯¹åº”runnerå¯ä»¥æœ‰ä¸åŒçš„ç³»ç»Ÿç¯å¢ƒã€‚tagså¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œä¸€ä¸ªé¡¹ç›®ä¸‹çš„urlå’Œtokenå¯ä»¥å…¬ç”¨ï¼Œä½†æ˜¯è¾“å…¥tagsçš„æ—¶å€™ä¸€å®šè¦æ³¨æ„ä¸è¦é‡å¤ã€‚ä¸ç„¶ä¹‹åè‡ªåŠ¨åŒ–éƒ¨ç½²ä¼šå‡ºç°é—®é¢˜ã€‚
   
   # æœ€åé€‰æ‹©excutorï¼šé€‰æ‹©shell.
   #å¯é€‰é¡¹å¦‚ä¸‹ï¼šEnter an executor: virtualbox, docker-ssh+machine, kubernetes, custom, docker-windows, docker-ssh, shell, docker, parallels, ssh, docker+machine
   ```

   åœ¨ä¸åŒçš„æœåŠ¡å™¨æˆ–è€…æœ¬åœ°è®¡ç®—æœºä¸Šæ³¨å†Œå°½å¯èƒ½å¤šçš„runnerã€‚gitlab æœåŠ¡å™¨æŸ¥çœ‹ç»“æœå¦‚ä¸‹ï¼š

   ![runner](https://raw.githubusercontent.com/Acemyzoe/myblog/master/blog-img/runner.png)

### Runneré…ç½®

åœ¨å®‰è£…gitlab-runner.exeçš„æ—¶å€™ä¼šç”Ÿäº§ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼šconfig.toml

é’ˆå¯¹windowsçš„powershellï¼Œæ–‡ä»¶ä¸­shell = 'pwsh'è¦æ”¹æˆshell = 'powershell'

```toml
concurrent = 1
check_interval = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "ci/cd test"
  url = "http://10.55.3.117/"
  token = "wkbu-JTWgei1347EPf-y"
  executor = "shell"
  shell = "powershell"
  [runners.custom_build_dir]
  [runners.cache]
    [runners.cache.s3]
    [runners.cache.gcs]
    [runners.cache.azure]
```



## CI/CD

### Windowä¸‹CIæŒç»­é›†æˆ

[CI/CDå®˜æ–¹æ–‡æ¡£](https://docs.gitlab.com/ee/ci/quick_start/)

ç°ä»¥Monitoringè¿™ä¸ªé¡¹ç›®ä¸ºä¾‹è¿›è¡Œè‡ªåŠ¨åŒ–æµ‹è¯•ã€‚

1. è½¬åˆ°**"CI/CD >è®¾ç½®"ï¼Œ**ç„¶åå±•å¼€"**Runner**"ã€‚ç¡®ä¿æœ‰Runnerå¯ç”¨äºè¿è¡Œä½œä¸šã€‚

2. éœ€è¦åˆ›å»º.gitlab-ci.ymlï¼Œè¿™ä¸ªæ–‡ä»¶æ˜¯CI/CD æ‰§è¡Œæ—¶çš„é…ç½®æ–‡ä»¶ã€‚

   åœ¨æ­¤æ–‡ä»¶ä¸­ï¼Œå¯ä»¥å®šä¹‰ï¼š

   - Runneråº”æ‰§è¡Œçš„ä½œä¸šçš„ç»“æ„å’Œé¡ºåºã€‚
   - Runneråœ¨é‡åˆ°ç‰¹å®šæƒ…å†µæ—¶åº”åšå‡ºçš„å†³å®šã€‚

   1. åœ¨gitlabçš„webç•Œé¢å¢åŠ æ–‡ä»¶ï¼Œä¹‹ååœ¨CI/CDâ€”>ç¼–è¾‘å™¨å¯ä»¥æ–¹ä¾¿ç¼–è¾‘ymlæ–‡ä»¶å¹¶æäº¤æµ‹è¯•ã€‚

      > æ¨èwebä¸­çš„ç®¡é“ç¼–è¾‘å™¨å†…ç¼–è¾‘ymlï¼Œå¯æµè§ˆæ¨¡æ¿ï¼Œå¯ä½¿ç”¨è‡ªåŠ¨è¯­æ³•çªå‡ºæ˜¾ç¤ºå’ŒéªŒè¯ç¼–è¾‘ç®¡é“é…ç½®ã€‚

   3. gitlab-ci.ymlæ–‡ä»¶çš„ç®€å•ç¤ºä¾‹ï¼Œæ›´å¤šå¯å‚è€ƒæ–‡æ¡£[".gitlab-ci.yml"æ–‡ä»¶](https://docs.gitlab.com/ee/ci/yaml/index.html)

```yml
.shared_windows_runners:
  tags:
    - ace
    
stages:
  - build
  - test
  - deploy

before_script:
 - Set-Variable -Name "time" -Value (date -Format "%H:%m")
 - echo ${time}
 - echo "started by ${GITLAB_USER_NAME}"

job1-build:
  extends:
    - .shared_windows_runners
  stage: build
  script:
    - echo "running scripts in the build job"

job2-test:
  extends:
    - .shared_windows_runners
  stage: test
  script:
    - echo "running scripts in the test job"
    
job3-deploy:
  extends:
    - .shared_windows_runners
  stage: deploy
  script:
    - echo "running scripts in the deploy job"
```

```markdown
- tagsï¼šå…³é”®å­—ï¼Œå¯é€‰ï¼Œç”¨äºé€‰æ‹©å¯¹åº”çš„runner;
- stagesï¼šå…³é”®å­—ï¼Œå¯é€‰ï¼Œç”¨äºè‡ªå®šä¹‰ä»»åŠ¡æµç¨‹ã€‚è‹¥ç¼ºå¤±ï¼Œé»˜è®¤æµç¨‹ä¸ºï¼šbuild > test > deployï¼›
- job1ï¼šä»»åŠ¡åç§°ï¼Œå¯è‡ªç”±å®šä¹‰ï¼Œå¯åŒ…å«ç©ºæ ¼ï¼›
- stageï¼šå…³é”®å­—ï¼Œç”¨äºæŒ‡å®šä»»åŠ¡åœ¨ä»€ä¹ˆstageè¿è¡Œï¼›
- scriptï¼šå…³é”®å­—ï¼ŒæŒ‰é¡ºåºæ’°å†™è¯¥ä»»åŠ¡çš„shellè„šæœ¬ï¼›
- onlyï¼šå…³é”®å­—ï¼Œç”¨äºæŒ‡å®šä¾èµ–çš„ä»£ç åˆ†æ”¯ï¼›
```

3. æäº¤ä¿®æ”¹æˆ–è€…æ¨é€åï¼Œgitlab-runnerä¼šè‡ªåŠ¨æ‹‰å–ä»£ç ï¼Œç„¶åæ‰§è¡Œä¸€ç³»åˆ—ymlæ–‡ä»¶ä¸­shellå‘½ä»¤ã€‚

   åœ¨CI/CD-ä½œä¸šå¯æŸ¥çœ‹æ‰§è¡Œè®°å½•å’Œå®æ—¶æ—¥å¿—ã€‚

   ![ci](https://raw.githubusercontent.com/Acemyzoe/myblog/master/blog-img/ci.png)



### GitLab CIé…ç½®æ–‡ä»¶.gitlab-ci.ymlè¯¦è§£

