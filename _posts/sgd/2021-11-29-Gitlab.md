title: Gitlab
tags:
  - sgd

# Gitlab

**官方文档**([GitLab Docs | GitLab](https://docs.gitlab.com/ee/))

**Linux 服务器**： 安装[Gitlab](https://about.gitlab.com/)

**Window /Linux服务器：**安装[Gitlab runner](https://docs.gitlab.com/runner/), powershell(系统自带)，[Git](https://git-scm.com/)（与Git lab交互拉取，推送代码)。

## 安装Gitlab

### 从Linux Package安装

[Download and install GitLab | GitLab](https://about.gitlab.com/install/)

以CentOS为例

```bash
# 可选：在系统防火墙中打开 HTTP、HTTPS 和 SSH 访问
sudo yum install -y curl policycoreutils-python openssh-server perl
# Enable OpenSSH server daemon if not enabled: sudo systemctl status sshd
sudo systemctl enable sshd
sudo systemctl start sshd

# Check if opening the firewall is needed with: sudo systemctl status firewalld
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo systemctl reload firewalld
```

```bash
# 可选：安装 Postfix 以发送通知电子邮件
sudo yum install postfix
sudo systemctl enable postfix
sudo systemctl start postfix
```

```shell
## 添加 GitLab 包存储库
curl https://packages.gitlab.com/install/repositories/gitlab/gitlab-ee/script.rpm.sh | sudo bash

## 安装Gitlab-ce（社区版）,ee(商业版)
sudo yum install -y gitlab-ce
```

```shell
# 备用选项:访问不通可更换镜像源，新建文件/etc/yum.repos.d/gitlab-ce.repo
# 或者直接下载rpm包，https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el7/
[gitlab-ce]
name=Gitlab CE Repository
baseurl=https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el$releasever/
gpgcheck=0
enabled=1 

# 然后执行安装
sudo yum makecache
sudo yum install -y gitlab-ce
```

### 从Docker安装

```shell
# 配置一个新的环境变量
export GITLAB_HOME=/srv/gitlab

# 使用 Docker 引擎安装 GitLab
sudo docker run --detach \
  --hostname gitlab.example.com \
  --publish 443:443 --publish 80:80 --publish 22:22 \
  --name gitlab \
  --restart always \
  --volume $GITLAB_HOME/config:/etc/gitlab \
  --volume $GITLAB_HOME/logs:/var/log/gitlab \
  --volume $GITLAB_HOME/data:/var/opt/gitlab \
  gitlab/gitlab-ce:latest
  
# 使用以下命令中的用户名和密码登录：root
sudo docker exec -it gitlab grep 'Password:' /etc/gitlab/initial_root_password
```



## 管理Gitlab

```shell
 # 查看gitlab版本
 head -1 /opt/gitlab/version-manifest.txt
 # 查看gitlab运行状态
 sudo gitlab-ctl status
```

用vim打开gitlab的配置文件：`vim /etc/gitlab/gitlab.rb`

完成配置后，执行 `gitlab-ctl reconfigure` 使配置生效。

1. 修改URL和系统端口：

   `external_url 'http://127.0.0.1'`
   改为：`external_url 'http://<服务器地址或域名>:<端口>'`

   > 连接wifi后获取服务器地址为10.55.3.117，external_url设置为`'http://10.55.3.117'`后，连同一WiFi设备（即同一局域网下）可访问gitlab。

2. 修改GitLab头像Gravatar源

```shell
vim /etc/gitlab/gitlab.rb
gitlab_rails['gravatar_plain_url'] = 'http://sdn.geekzu.org/avatar/%{hash}?s=%{size}&d=identicon'  
gitlab_rails['gravatar_ssl_url'] = 'http://sdn.geekzu.org/avatar/%{hash}?s=%{size}&d=identicon' 
```

3. 浏览管理页面并登录

浏览器访问本机地址`'http://127.0.0.1'`或者自定义的域名`'http://10.55.3.117'`

密码将在安装过程随机生成并存储 24 小时。用户名`root` 密码`/etc/gitlab/initial_root_password`

4. 重置用户密码

```shell
sudo gitlab-rake "gitlab:password:reset"
# GitLab 要求输入用户名、密码和密码确认。（8位以上，可直接重置管理员密码,已修改为rootroot）
```

​	5.选择语言
setting ----preferences----Localization---简体中文



## 安装Gitlab Runner

### 在 Windows上安装 GitLab Runner[🔗](https://docs.gitlab.com/runner/install/windows.html)

1. 下载[64 位](https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-windows-amd64.exe)或[32 位](https://gitlab-runner-downloads.s3.amazonaws.com/latest/binaries/gitlab-runner-windows-386.exe)的二进制文件放到路径 C:\GitLab-Runner 文件夹下，重命名为gitlab-runner.exe

2. 以管理员身份运行CMD

   ```cmd
   # 安装为服务
   cd C:\GitLab-Runner
   # 使用用户账号安装
   .\gitlab-runner.exe install --user ENTER-YOUR-USERNAME --password ENTER-YOUR-PASSWORD
   # 以管理员账号安装
   .\gitlab-runner.exe install
   .\gitlab-runner.exe start
   ```

   ```cmd
   # 注册一个runner
   ./gitlab-runner.exe register
   # 之后输入URL, Token, description for the runner, tags for the runner
   # URL和token位置：项目设置->Settings->CI/CD->Runner
   
   # ！！tags：当在yml脚本里使用他的时候，根据tags 指定要使用的runner。不同tag对应runner可以有不同的系统环境。tags必须是唯一的，一个项目下的url和token可以公用，但是输入tags的时候一定要注意不要重复。不然之后自动化部署会出现问题。
   
   # 最后选择excutor：选择shell.
   #可选项如下：Enter an executor: virtualbox, docker-ssh+machine, kubernetes, custom, docker-windows, docker-ssh, shell, docker, parallels, ssh, docker+machine
   ```

   在不同的服务器或者本地计算机上注册尽可能多的runner。gitlab 服务器查看结果如下：

   ![runner](https://raw.githubusercontent.com/Acemyzoe/myblog/master/blog-img/runner.png)

### Runner配置

在安装gitlab-runner.exe的时候会生产一个配置文件：config.toml

针对windows的powershell，文件中shell = 'pwsh'要改成shell = 'powershell'

```toml
concurrent = 1
check_interval = 0

[session_server]
  session_timeout = 1800

[[runners]]
  name = "ci/cd test"
  url = "http://10.55.3.117/"
  token = "wkbu-JTWgei1347EPf-y"
  executor = "shell"
  shell = "powershell"
  [runners.custom_build_dir]
  [runners.cache]
    [runners.cache.s3]
    [runners.cache.gcs]
    [runners.cache.azure]
```



## CI/CD

### Window下CI持续集成

[CI/CD官方文档](https://docs.gitlab.com/ee/ci/quick_start/)

现以Monitoring这个项目为例进行自动化测试。

1. 转到**"CI/CD >设置"，**然后展开"**Runner**"。确保有Runner可用于运行作业。

2. 需要创建.gitlab-ci.yml，这个文件是CI/CD 执行时的配置文件。

   在此文件中，可以定义：

   - Runner应执行的作业的结构和顺序。
   - Runner在遇到特定情况时应做出的决定。

   1. 在gitlab的web界面增加文件，之后在CI/CD—>编辑器可以方便编辑yml文件并提交测试。

      > 推荐web中的管道编辑器内编辑yml，可浏览模板，可使用自动语法突出显示和验证编辑管道配置。

   3. gitlab-ci.yml文件的简单示例，更多可参考文档[".gitlab-ci.yml"文件](https://docs.gitlab.com/ee/ci/yaml/index.html)

```yml
.shared_windows_runners:
  tags:
    - ace
    
stages:
  - build
  - test
  - deploy

before_script:
 - Set-Variable -Name "time" -Value (date -Format "%H:%m")
 - echo ${time}
 - echo "started by ${GITLAB_USER_NAME}"

job1-build:
  extends:
    - .shared_windows_runners
  stage: build
  script:
    - echo "running scripts in the build job"

job2-test:
  extends:
    - .shared_windows_runners
  stage: test
  script:
    - echo "running scripts in the test job"
    
job3-deploy:
  extends:
    - .shared_windows_runners
  stage: deploy
  script:
    - echo "running scripts in the deploy job"
```

```markdown
- tags：关键字，可选，用于选择对应的runner;
- stages：关键字，可选，用于自定义任务流程。若缺失，默认流程为：build > test > deploy；
- job1：任务名称，可自由定义，可包含空格；
- stage：关键字，用于指定任务在什么stage运行；
- script：关键字，按顺序撰写该任务的shell脚本；
- only：关键字，用于指定依赖的代码分支；
```

3. 提交修改或者推送后，gitlab-runner会自动拉取代码，然后执行一系列yml文件中shell命令。

   在CI/CD-作业可查看执行记录和实时日志。

   ![ci](https://raw.githubusercontent.com/Acemyzoe/myblog/master/blog-img/ci.png)



### GitLab CI配置文件.gitlab-ci.yml详解

