---
titleï¼šk8s
tagsï¼šsgd
---
[kuboard](https://kuboard.cn/install/install-k8s.html)

# ç›´æ¥éƒ¨ç½²

## å•masterèŠ‚ç‚¹

```shell
##### æ£€æŸ¥ centos / hostname
# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
cat /etc/redhat-release

# æ­¤å¤„ hostname çš„è¾“å‡ºå°†ä¼šæ˜¯è¯¥æœºå™¨åœ¨ Kubernetes é›†ç¾¤ä¸­çš„èŠ‚ç‚¹åå­—
# ä¸èƒ½ä½¿ç”¨ localhost ä½œä¸ºèŠ‚ç‚¹çš„åå­—
hostname
# ä¿®æ”¹ hostname
hostnamectl set-hostname your-new-host-name
# æŸ¥çœ‹ä¿®æ”¹ç»“æœ
hostnamectl status
# è®¾ç½® hostname è§£æ
echo "127.0.0.1   $(hostname)" >> /etc/hosts

# è¯·ä½¿ç”¨ lscpu å‘½ä»¤ï¼Œæ ¸å¯¹ CPU ä¿¡æ¯
# Architecture: x86_64    æœ¬å®‰è£…æ–‡æ¡£ä¸æ”¯æŒ arm æ¶æ„
# CPU(s):       2         CPU å†…æ ¸æ•°é‡ä¸èƒ½ä½äº 2
lscpu
```

```shell
##### å®‰è£…containerd/kubelet/kubeadm/kubectl
# åœ¨ master èŠ‚ç‚¹å’Œ worker èŠ‚ç‚¹éƒ½è¦æ‰§è¡Œ
# æœ€åä¸€ä¸ªå‚æ•° 1.22.3 ç”¨äºæŒ‡å®š kubenetes ç‰ˆæœ¬ï¼Œæ”¯æŒæ‰€æœ‰ 1.22.x ç‰ˆæœ¬çš„å®‰è£…
# é˜¿é‡Œäº‘ docker hub é•œåƒ
export REGISTRY_MIRROR=https://registry.cn-hangzhou.aliyuncs.com
curl -sSL https://kuboard.cn/install-script/v1.22.x/install_kubelet.sh | sh -s 1.22.3
```

```shell
# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹å®é™… IPï¼ˆè¯·ä½¿ç”¨å†…ç½‘ IPï¼‰
# export å‘½ä»¤åªåœ¨å½“å‰ shell ä¼šè¯ä¸­æœ‰æ•ˆï¼Œå¼€å¯æ–°çš„ shell çª—å£åï¼Œå¦‚æœè¦ç»§ç»­å®‰è£…è¿‡ç¨‹ï¼Œè¯·é‡æ–°æ‰§è¡Œæ­¤å¤„çš„ export å‘½ä»¤
export MASTER_IP=x.x.x.x
# æ›¿æ¢ apiserver.demo ä¸º æ‚¨æƒ³è¦çš„ dnsName
export APISERVER_NAME=apiserver.demo
# Kubernetes å®¹å™¨ç»„æ‰€åœ¨çš„ç½‘æ®µï¼Œè¯¥ç½‘æ®µå®‰è£…å®Œæˆåï¼Œç”± kubernetes åˆ›å»ºï¼Œäº‹å…ˆå¹¶ä¸å­˜åœ¨äºæ‚¨çš„ç‰©ç†ç½‘ç»œä¸­
export POD_SUBNET=10.100.0.0/16
echo "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts
curl -sSL https://kuboard.cn/install-script/v1.22.x/init_master.sh | sh -s 1.22.3 /coredns

# åªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
# æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œç­‰å¾… 3-10 åˆ†é’Ÿï¼Œç›´åˆ°æ‰€æœ‰çš„å®¹å™¨ç»„å¤„äº Running çŠ¶æ€
watch kubectl get pod -n kube-system -o wide
# æŸ¥çœ‹ master èŠ‚ç‚¹åˆå§‹åŒ–ç»“æœ
kubectl get nodes -o wide

# å®‰è£…ç½‘ç»œæ’ä»¶ flannel
export POD_SUBNET=10.100.0.0/16
wget https://kuboard.cn/install-script/flannel/flannel-v0.14.0.yaml
sed -i "s#10.244.0.0/16#${POD_SUBNET}#" flannel-v0.14.0.yaml
kubectl apply -f ./flannel-v0.14.0.yaml

# è·å¾— joinå‘½ä»¤å‚æ•°ï¼Œåªåœ¨ master èŠ‚ç‚¹æ‰§è¡Œ
kubeadm token create --print-join-command
```

```shell
# åªåœ¨ worker èŠ‚ç‚¹æ‰§è¡Œ
# æ›¿æ¢ x.x.x.x ä¸º master èŠ‚ç‚¹çš„å†…ç½‘ IP
export MASTER_IP=x.x.x.x
# æ›¿æ¢ apiserver.demo ä¸ºåˆå§‹åŒ– master èŠ‚ç‚¹æ—¶æ‰€ä½¿ç”¨çš„ APISERVER_NAME
export APISERVER_NAME=apiserver.demo
echo "${MASTER_IP}    ${APISERVER_NAME}" >> /etc/hosts

# æ›¿æ¢ä¸º master èŠ‚ç‚¹ä¸Š kubeadm token create å‘½ä»¤çš„è¾“å‡º
kubeadm join apiserver.demo:6443 --token **     --discovery-token-ca-cert-hash **
```

## é«˜å¯ç”¨k8s

> ä¸‰ä¸ª master ç»„æˆä¸»èŠ‚ç‚¹é›†ç¾¤ï¼Œé€šè¿‡å†…ç½‘ loader balancer å®ç°è´Ÿè½½å‡è¡¡ï¼›è‡³å°‘éœ€è¦ä¸‰ä¸ª master èŠ‚ç‚¹æ‰å¯ç»„æˆé«˜å¯ç”¨é›†ç¾¤ï¼Œå¦åˆ™ä¼šå‡ºç° ***è„‘è£‚*** ç°è±¡ã€‚(masterèŠ‚ç‚¹ä¸ªæ•°ä¸€èˆ¬ä¹Ÿä¸ºå¥‡æ•°)
>
> å¤šä¸ª worker ç»„æˆå·¥ä½œèŠ‚ç‚¹é›†ç¾¤ï¼Œé€šè¿‡å¤–ç½‘ loader balancer å®ç°è´Ÿè½½å‡è¡¡

```shell
##### æ£€æŸ¥ centos / hostname
##### å®‰è£…containerd/kubelet/kubeadm/kubectl

# åˆ›å»º ApiServer çš„ Load Balancerï¼ˆç§ç½‘ï¼‰
#å¯é€‰ï¼šnginxã€haproxyã€keepalivedã€äº‘ä¾›åº”å•†æä¾›çš„è´Ÿè½½å‡è¡¡äº§å“

# åˆå§‹åŒ–ç¬¬ä¸€ä¸ªmasterèŠ‚ç‚¹

# åˆå§‹åŒ–ç¬¬2ã€3ä¸ªmasterèŠ‚ç‚¹
# åªåœ¨ ç¬¬ä¸€ä¸ª master èŠ‚ç‚¹ demo-master-a-1 ä¸Šæ‰§è¡Œ
kubeadm init phase upload-certs --upload-certs
kubeadm token create --print-join-command # è¾“å‡º**

kubeadm join apiserver.demo:6443 --token ejwx62.vqwog6il5p83uk7y \
--discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303 \
--control-plane --certificate-key **

# åˆå§‹åŒ–workerèŠ‚ç‚¹
kubeadm join apiserver.demo:6443 --token mpfjma.4vjjg8flqihor4vt     --discovery-token-ca-cert-hash sha256:6f7a8e40a810323672de5eee6f4d19aa2dbdb38411845a1bf5dd63485c43d303

# ç§»é™¤workerèŠ‚ç‚¹
kubeadm reset # åœ¨workerèŠ‚ç‚¹è¿è¡Œ
kubectl delete node demo-worker-x-x # åœ¨masterèŠ‚ç‚¹è¿è¡Œ
```

# ä¸€é”®éƒ¨ç½²k8så·¥å…·

## [k3s](https://github.com/k3s-io/k3s)

```shell
# masterèŠ‚ç‚¹
curl -sfL https://get.k3s.io | sh -
cat /etc/rancher/k3s/k3s.yaml

# workerèŠ‚ç‚¹
cat /var/lib/rancher/k3s/server/node-token
curl -sfL https://get.k3s.io | K3S_URL=https://myserver:6443 K3S_TOKEN=XXX sh -
```

## [sealos](https://www.sealyun.com/)

```shell
# ä¸‹è½½å¹¶å®‰è£…sealos, sealosæ˜¯ä¸ªgolangçš„äºŒè¿›åˆ¶å·¥å…·ï¼Œç›´æ¥ä¸‹è½½æ‹·è´åˆ°binç›®å½•å³å¯, releaseé¡µé¢ä¹Ÿå¯ä¸‹è½½
$ wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/latest/sealos && \
    chmod +x sealos && mv sealos /usr/bin 

# ä¸‹è½½ç¦»çº¿èµ„æºåŒ…
$ wget -c https://sealyun.oss-cn-beijing.aliyuncs.com/05a3db657821277f5f3b92d834bbaf98-v1.22.0/kube1.22.0.tar.gz

# å®‰è£…ä¸€ä¸ªä¸‰masterçš„kubernetesé›†ç¾¤
$ sealos init --passwd '123456' \
	--master 192.168.0.2  --master 192.168.0.3  --master 192.168.0.4  \
	--node 192.168.0.5 \
	--pkg-url /root/kube1.22.0.tar.gz \
	--version v1.22.0
```

```shell
# å¢åŠ master
ğŸ³ â†’ sealos join --master 192.168.0.6 --master 192.168.0.7
ğŸ³ â†’ sealos join --master 192.168.0.6-192.168.0.9  # æˆ–è€…å¤šä¸ªè¿ç»­IP
# å¢åŠ node
ğŸ³ â†’ sealos join --node 192.168.0.6 --node 192.168.0.7
ğŸ³ â†’ sealos join --node 192.168.0.6-192.168.0.9  # æˆ–è€…å¤šä¸ªè¿ç»­IP
# æ¸…ç†é›†ç¾¤
ğŸ³ â†’ sealos clean --all
```
